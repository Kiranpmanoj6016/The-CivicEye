<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIVIC EYE - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #priorityMap { height: 400px; width: 100%; border-radius: 8px; margin-top: 15px; }
        .admin-nav { display: flex; gap: 15px; margin-bottom: 20px; }
        .admin-nav a { text-decoration: none; flex-grow: 1; }
        .admin-nav button { width: 100%; background-color: #0d6efd; }
        .priority-container { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .priority-map-container { flex: 2; min-width: 300px; }
        .priority-list-container { flex: 1; min-width: 250px; max-height: 450px; overflow-y: auto; }
        .priority-item { background: #f9f9f9; border-left: 5px solid #dc3545; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <header>CIVIC EYE - Admin Dashboard</header>
    <div class="profile-container">
        <button class="profile-btn" onclick="toggleDropdown()">My Profile â–¾</button>
        <div class="profile-dropdown" id="profileDropdown"><a href="#" onclick="logoutUser()">Logout</a></div>
    </div>
    <div class="dashboard-section">
        <div class="admin-nav">
            <a href="manage_staff.html"><button>Manage Staff</button></a>
            <a href="create_user.html"><button>Create New User</button></a>
            <a href="analytics.html"><button>Analytics</button></a>
        </div>
        <hr>
        <div class="summary-cards">
            <div class="card"><h3>Total Issues</h3><p id="total-issues">0</p></div>
            <div class="card"><h3>Pending</h3><p id="pending-issues">0</p></div>
            <div class="card"><h3>Completed</h3><p id="completed-issues">0</p></div>
        </div>
        <div class="priority-container">
            <div class="priority-map-container">
                <h2>Issue Hotspots Map</h2>
                <p>This map groups nearby active issues to show problem areas.</p>
                <div id="priorityMap"></div>
            </div>
            <div class="priority-list-container">
                <h2>Priority Area List</h2>
                <div id="priorityList"></div>
            </div>
        </div>
        <h2>All Reported Issues</h2>
        <table class="issue-table">
            <thead>
                <tr>
                    <th>Photo</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Tags</th>
                    <th>Assigned To</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="issuesTableBody"></tbody>
        </table>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        function toggleDropdown() { document.getElementById("profileDropdown").style.display = document.getElementById("profileDropdown").style.display === "block" ? "none" : "block"; }
    </script>
    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { logout, getDistance, fetchAuthorizedUsers } from "./script.js";
        window.logoutUser = logout;
        
        let allIssues = [];
        let authorizedUsers = [];

        async function initializeDashboard() {
            authorizedUsers = await fetchAuthorizedUsers();
            setupRealTimeListener();
        }
        
        // NEW: Real-time listener function
        function setupRealTimeListener() {
            const issuesCollection = collection(db, "issues");
            onSnapshot(issuesCollection, (snapshot) => {
                allIssues = [];
                snapshot.forEach(doc => {
                    allIssues.push({ id: doc.id, ...doc.data() });
                });
                renderIssues(allIssues);
                updateSummaryCards(allIssues);
                renderPriorityView(allIssues);
            });
        }
        
        function renderIssues(issues) {
            const issuesTableBody = document.getElementById("issuesTableBody");
            issuesTableBody.innerHTML = "";
            if (issues.length === 0) {
                issuesTableBody.innerHTML = '<tr><td colspan="6">No issues found.</td></tr>';
                return;
            }
            issues.forEach(issue => {
                const row = issuesTableBody.insertRow();
                row.id = `issue-row-${issue.id}`;
                const tagsHtml = (issue.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ');
                
                let assignDropdown = `<select id="assign-select-${issue.id}"><option value="">Unassigned</option>`;
                authorizedUsers.forEach(user => {
                    assignDropdown += `<option value="${user.uid}">${user.name}</option>`;
                });
                assignDropdown += `</select>`;
                
                const assignedUser = authorizedUsers.find(user => user.uid === issue.assignedTo);
                const assignedToName = assignedUser ? assignedUser.name : "Unassigned";

                row.innerHTML = `
                    <td><a href="${issue.photoURL}" target="_blank"><img src="${issue.photoURL}" width="100" alt="Issue Photo" /></a></td>
                    <td>${issue.description}<br><button class="map-button" onclick="window.showMap(${issue.location.latitude}, ${issue.location.longitude})">View on Map</button></td>
                    <td><strong class="status-${issue.status.toLowerCase().replace(' ', '-')}">${issue.status}</strong></td>
                    <td>${tagsHtml}</td>
                    <td><span id="assigned-to-${issue.id}">${assignedToName}</span></td>
                    <td class="action-buttons">
                        ${assignDropdown}
                        <button class="update-btn" onclick="window.handleAssign('${issue.id}')">Assign</button>
                    </td>
                `;
                if (issue.assignedTo) {
                    document.getElementById(`assign-select-${issue.id}`).value = issue.assignedTo;
                }
            });
        }
        
        window.handleAssign = async (issueId) => {
            const assignedToID = document.getElementById(`assign-select-${issueId}`).value;
            if (!assignedToID) {
                alert("Please select a staff member to assign the issue.");
                return;
            }
            try {
                await updateDoc(doc(db, "issues", issueId), {
                    assignedTo: assignedToID,
                    status: "In Progress"
                });
                alert("Issue assigned successfully!");
            } catch (error) {
                console.error("Error assigning issue:", error);
                alert("Failed to assign issue. Please try again.");
            }
        };

        function renderPriorityView(issues) {
            const mapContainer = document.getElementById("priorityMap");
            const listContainer = document.getElementById("priorityList");
            if (window.priorityMapInstance) { window.priorityMapInstance.remove(); }
            const map = L.map(mapContainer).setView([8.5241, 76.9366], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            window.priorityMapInstance = map;
            let clusters = []; const clusterRadius = 15;
            const activeIssues = issues.filter(issue => issue.status === 'Pending' || issue.status === 'In Progress');
            activeIssues.forEach(issue => {
                let foundCluster = false;
                for (const cluster of clusters) {
                    if (getDistance(issue.location.latitude, issue.location.longitude, cluster.lat, cluster.lng) <= clusterRadius) {
                        cluster.issues.push(issue); foundCluster = true; break;
                    }
                }
                if (!foundCluster) { clusters.push({ lat: issue.location.latitude, lng: issue.location.longitude, issues: [issue] }); }
            });
            clusters.sort((a, b) => b.issues.length - a.issues.length);
            listContainer.innerHTML = clusters.length > 0 ? "" : "<p>No active hotspots found.</p>";
            clusters.forEach((cluster, index) => {
                const marker = L.marker([cluster.lat, cluster.lng]).addTo(map);
                marker.bindPopup(`<b>${cluster.issues.length} Active Issues Here</b>`);
                if (cluster.issues.length > 1) {
                    const listItem = document.createElement("div");
                    listItem.className = "priority-item";
                    const tagsInCluster = [...new Set(cluster.issues.flatMap(i => i.tags || []))].join(', ');
                    listItem.innerHTML = `<h4>Priority Area #${index + 1} (${cluster.issues.length} issues)</h4><p><strong>Problem Types:</strong> ${tagsInCluster}</p><button class="map-button" style="padding: 5px 10px; font-size: 0.8rem;" onclick="window.focusOnMap([${cluster.lat}, ${cluster.lng}])">Focus on Map</button>`;
                    listContainer.appendChild(listItem);
                }
            });
            window.focusOnMap = (coords) => map.setView(coords, 18);
        }

        function updateSummaryCards(issues) {
            document.getElementById('total-issues').textContent = issues.length;
            document.getElementById('pending-issues').textContent = issues.filter(i => i.status === 'Pending').length;
            document.getElementById('completed-issues').textContent = issues.filter(i => i.status === 'Completed').length;
        }

        initializeDashboard();
    </script>
</body>
</html>